#!/bin/bash
# filepath: /home/rustuser/rustdev/LinossRust/compare_eand

# Source and destination directories
SOURCE="/home/rustuser/rustdev/LinossRust-ItCrashhhed"
DEST="/home/rustuser/rustdev/LinossRust"

# Create a list of files in source that aren't in destination
echo "Finding files that exist in crashed version but not in current workspace..."
mkdir -p "$DEST/recovered_files"

# Copy development-management directory (excluding web/WASM content)
if [ -d "$SOURCE/development-management" ]; then
  echo "Copying development-management directory..."
  cp -r "$SOURCE/development-management" "$DEST/"
fi

# Find and copy source files (excluding WASM/web-related)
find "$SOURCE" -type f \( -name "*.rs" -o -name "*.toml" -o -name "*.md" \) \
  | grep -v "wasm\|web-show\|web_demo" \
  | while read file; do
    rel_path=${file#$SOURCE/}
    dest_file="$DEST/$rel_path"
    
    if [ ! -f "$dest_file" ]; then
      # File doesn't exist in destination
      echo "New file: $rel_path"
      mkdir -p "$(dirname "$dest_file")"
      cp "$file" "$dest_file"
    else
      # File exists in both - check if different
      if ! cmp -s "$file" "$dest_file"; then
        echo "Modified file: $rel_path"
        mkdir -p "$DEST/recovered_files/$(dirname "$rel_path")"
        cp "$file" "$DEST/recovered_files/$rel_path"
        echo "Copied to recovered_files/ for manual review"
      fi
    fi
  done

echo "Recovery process complete. Modified files were placed in recovered_files/ directory for your review."
echo "Next steps: Check the files in recovered_files/ and manually merge changes as needed."

# Automated merge and logging
LOGFILE="$DEST/recovered_files/RECOVERY_LOG_$(date +%Y%m%d_%H%M%S).txt"
echo "--- Recovery Log $(date) ---" > "$LOGFILE"

# Process all files in recovered_files
find "$DEST/recovered_files" -type f | while read recovered; do
  rel_path=${recovered#$DEST/recovered_files/}
  dest_file="$DEST/$rel_path"
  backup_file="$DEST/recovered_files/backup_${rel_path}.$(date +%Y%m%d_%H%M%S)"
  mkdir -p "$(dirname "$dest_file")"
  mkdir -p "$(dirname "$backup_file")"
  if [ -f "$dest_file" ]; then
    # Backup current file
    cp "$dest_file" "$backup_file"
    echo "[MODIFIED] $rel_path: Backed up to $backup_file and replaced with recovered version" | tee -a "$LOGFILE"
  else
    echo "[NEW] $rel_path: Added to project" | tee -a "$LOGFILE"
  fi
  # Move recovered file into place
  cp "$recovered" "$dest_file"
done

echo "Automated merge complete. See $LOGFILE for details."
